(function(){var b,a;a=this;this.hatemile||(this.hatemile={});(b=this.hatemile).implementation||(b.implementation={});this.hatemile.implementation.AccessibleNavigationImplementation=(function(){var j,m,h,d,k,i,f,c,o,g,n,e;n="container-skippers";g="container-heading";e="text-heading";d="skipper-anchor";h="heading-anchor";m="force-link-before";j="force-link-after";k="data-anchorfor";c="data-headinganchorfor";o="data-headinglevel";f="data-attributelongdescriptionbeforeof";i="data-attributelongdescriptionafterof";l.prototype._generateListSkippers=function(){var p,r,q;p=this.parser.find("#"+n).firstResult();if(p===null){q=this.parser.find("body").firstResult();if(q!==null){p=this.parser.createElement("div");p.setAttribute("id",n);q.prependElement(p)}}r=null;if(p!==null){r=this.parser.find(p).findChildren("ul").firstResult();if(r===null){r=this.parser.createElement("ul");p.appendElement(r)}}this.listSkippersAdded=true;return r};l.prototype._generateListHeading=function(){var p,r,q,s;p=this.parser.find("#"+g).firstResult();if(p===null){q=this.parser.find("body").firstResult();if(q!==null){p=this.parser.createElement("div");p.setAttribute("id",g);s=this.parser.createElement("span");s.setAttribute("id",e);p.appendElement(s);if(this.elementsHeadingBefore.length>0){s.appendText(this.elementsHeadingBefore);q.prependElement(p)}if(this.elementsHeadingAfter.length>0){s.appendText(this.elementsHeadingAfter);q.appendElement(p)}}}r=null;if(p!==null){r=this.parser.find(p).findChildren("ol").firstResult();if(r===null){r=this.parser.createElement("ol");p.appendElement(r)}}return r};l.prototype._getHeadingLevel=function(q){var p;p=q.getTagName();if(p==="H1"){return 1}else{if(p==="H2"){return 2}else{if(p==="H3"){return 3}else{if(p==="H4"){return 4}else{if(p==="H5"){return 5}else{if(p==="H6"){return 6}else{return -1}}}}}}};l.prototype._isValidHeading=function(){var u,r,t,q,s,p,v;this.validateHeading=true;t=this.parser.find("h1,h2,h3,h4,h5,h6").listResults();s=0;u=0;for(q=0,p=t.length;q<p;q++){r=t[q];v=this._getHeadingLevel(r);if(v===1){if(u===1){return false}else{u=1}}if(v-s>1){return false}s=v}return true};l.prototype._generateAnchorFor=function(s,q,r){var p;this.idGenerator.generateId(s);p=null;if(this.parser.find("["+q+'="'+(s.getAttribute("id"))+'"]').firstResult()===null){if(s.getTagName()==="A"){p=s}else{p=this.parser.createElement("a");this.idGenerator.generateId(p);p.setAttribute("class",r);s.insertBefore(p)}if(!p.hasAttribute("name")){p.setAttribute("name",p.getAttribute("id"))}p.setAttribute(q,s.getAttribute("id"))}return p};l.prototype._freeShortcut=function(s){var A,v,x,p,C,w,u,r,B,z,t,q,y;A="1234567890abcdefghijklmnopqrstuvwxyz";p=this.parser.find("[accesskey]").listResults();for(w=0,z=p.length;w<z;w++){v=p[w];y=v.getAttribute("accesskey").toLowerCase();if(a.hatemile.util.CommonFunctions.inList(y,s)){for(u=0,t=A.length;u<t;u++){B=A[u];C=true;for(r=0,q=p.length;r<q;r++){x=p[r];y=x.getAttribute("accesskey").toLowerCase();if(a.hatemile.util.CommonFunctions.inList(y,B)){C=false;break}}if(C){v.setAttribute("accesskey",B);break}}if(C){break}}}};function l(r,q,p){this.parser=r;this.configure=q;this.skippers=p;this.idGenerator=new hatemile.util.IDGenerator("navigation");this.attributeLongDescriptionPrefixBefore=this.configure.getParameter("attribute-longdescription-prefix-before");this.attributeLongDescriptionSuffixBefore=this.configure.getParameter("attribute-longdescription-suffix-before");this.attributeLongDescriptionPrefixAfter=this.configure.getParameter("attribute-longdescription-prefix-after");this.attributeLongDescriptionSuffixAfter=this.configure.getParameter("attribute-longdescription-suffix-after");this.elementsHeadingBefore=this.configure.getParameter("elements-heading-before");this.elementsHeadingAfter=this.configure.getParameter("elements-heading-after");this.listSkippersAdded=false;this.validateHeading=false;this.validHeading=false;this.listSkippers=null}l.prototype.provideNavigationBySkipper=function(u){var w,x,B,q,v,A,t,z,s,C,p,r,y,D;D=null;p=this.skippers;for(v=0,z=p.length;v<z;v++){q=p[v];B=this.parser.find(q.selector).listResults();for(t=0,s=B.length;t<s;t++){x=B[t];if(x.equals(u)){D=q;break}}if(D!==null){break}}if(D!==null){if(!this.listSkippersAdded){this.listSkippers=this._generateListSkippers()}if(this.listSkippers!==null){w=this._generateAnchorFor(u,k,d);if(w!==null){A=this.parser.createElement("li");C=this.parser.createElement("a");C.setAttribute("href","#"+(w.getAttribute("name")));C.appendText(this.configure.getParameter(D.description));y=D.shortcut;if((y!==void 0)&&(y.length>0)){r=y[0];this._freeShortcut(r);C.setAttribute("accesskey",r)}this.idGenerator.generateId(C);A.appendElement(C);this.listSkippers.appendElement(A)}}}};l.prototype.provideNavigationByAllSkippers=function(){var t,v,s,r,p,q,u,w;u=this.skippers;for(s=0,p=u.length;s<p;s++){w=u[s];v=this.parser.find(w.selector).listResults();for(r=0,q=v.length;r<q;r++){t=v[r];if(a.hatemile.util.CommonFunctions.isValidElement(t)){this.provideNavigationBySkipper(t)}}}};l.prototype.provideNavigationByHeading=function(u){var q,s,v,r,t,p;if(!this.validateHeading){this.validHeading=this._isValidHeading()}if(this.validHeading){q=this._generateAnchorFor(u,c,h);if(q!==null){v=this._getHeadingLevel(u);if(v===1){t=this._generateListHeading()}else{p=this.parser.find("#"+g).findDescendants(("["+o+'="')+(((v-1).toString())+'"]')).lastResult();if(p!==null){t=this.parser.find(p).findChildren("ol").firstResult();if(t===null){t=this.parser.createElement("ol");p.appendElement(t)}}}if(t!==null){s=this.parser.createElement("li");s.setAttribute(o,v.toString());r=this.parser.createElement("a");r.setAttribute("href","#"+(q.getAttribute("name")));r.appendText(u.getTextContent());s.appendElement(r);t.appendElement(s)}}}};l.prototype.provideNavigationByAllHeadings=function(){var r,s,q,p;s=this.parser.find("h1,h2,h3,h4,h5,h6").listResults();for(q=0,p=s.length;q<p;q++){r=s[q];if(a.hatemile.util.CommonFunctions.isValidElement(r)){this.provideNavigationByHeading(r)}}};l.prototype.provideNavigationToLongDescription=function(r){var p,q,t,s;if(r.hasAttribute("longdesc")){this.idGenerator.generateId(r);t=r.getAttribute("id");if(r.hasAttribute("alt")){if(this.parser.find("["+f+'="'+t+'"]').firstResult()===null){if((this.attributeLongDescriptionPrefixBefore.length>0)||(this.attributeLongDescriptionSuffixBefore.length>0)){q=(""+this.attributeLongDescriptionPrefixBefore)+(""+(r.getAttribute("alt")))+(""+this.attributeLongDescriptionSuffixBefore);p=this.parser.createElement("a");p.setAttribute("href",r.getAttribute("longdesc"));p.setAttribute("target","_blank");p.setAttribute(f,t);p.setAttribute("class",m);p.appendText(q);r.insertBefore(p)}}if(this.parser.find("["+i+'="'+t+'"]').firstResult()===null){if((this.attributeLongDescriptionPrefixAfter.length>0)||(this.attributeLongDescriptionSuffixAfter.length>0)){s=(""+this.attributeLongDescriptionPrefixAfter)+(""+(r.getAttribute("alt")))+(""+this.attributeLongDescriptionSuffixAfter);p=this.parser.createElement("a");p.setAttribute("href",r.getAttribute("longdesc"));p.setAttribute("target","_blank");p.setAttribute(i,t);p.setAttribute("class",j);p.appendText(s);r.insertAfter(p)}}}}};l.prototype.provideNavigationToAllLongDescriptions=function(){var r,s,q,p;s=this.parser.find("[longdesc]").listResults();for(q=0,p=s.length;q<p;q++){r=s[q];if(a.hatemile.util.CommonFunctions.isValidElement(r)){this.provideNavigationToLongDescription(r)}}};return l})()}).call(this);